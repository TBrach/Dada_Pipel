---
title: "DESeqLibrarySizeAdjustments"
author: "Thorsten Brach"
date: "22/11/2017"
output: html_document
---


```{r, echo = FALSE, message=FALSE, include = FALSE}
# source("https://bioconductor.org/biocLite.R")
# biocLite("phyloseq")
library(phyloseq); packageVersion("phyloseq")
library(dada2); packageVersion("dada2")
library(vegan); packageVersion("vegan")
library(ggplot2); packageVersion("ggplot2")
library(dplyr); packageVersion("dplyr")
library(tidyr); packageVersion("tidyr")
library(gridExtra); packageVersion("gridExtra")
library(xtable); packageVersion("xtable")
library(RVAideMemoire); packageVersion("RVAideMemoire")
library(viridis); packageVersion("viridis")
library(scales); packageVersion("scales") # for the oob = squish option in gradient plots
library(ggthemes); packageVersion("ggthemes")
library(DESeq2); packageVersion("DESeq2")
```

# Load an example phyloseq object

```{r, message = FALSE, warning =FALSE}

# TestPhyloseq.rds must be in working directory

ps <- readRDS(file = "TestPhyloseq.rds")

group_var <- "Group"

```

# The type options of estimateSizeFactors from DESeq2

- **NB: what is exemplified here is in short described under the type argument in the help to estimateSizeFactors**
- **I recommend to look at the examples here anyway :)**
- estimateSizeFactors has now three type options: **ratio**, **iterate**, and **poscounts**
- when set to **ratio**, the function will use the ratio method described in the original paper Anders et al. (2010) equation (5) and the code can be found via body(estimateSizeFactorsForMatrix)
- When no **geoMeans** is given, the function will only consider taxa present in all samples to calculate the GM/reference sample. Since the data is often sparse, this leaves very few or even no taxa. If no taxa, then you get an error: "**every gene contains at least one zero**"

## Illustrating the error for type = "ratio" and geoMeans not given when all taxa contain at least 1 zero count


```{r}

# generate a new phyloseq object that contains only taxa with at least one zero count in one of the samples
count_table <- t(as(otu_table(ps), "matrix")) # taxa are rows now

sum(rowSums(count_table == 0) > 0) 
# 836 of the 862 ASV contain at least one zero

ps2 <- prune_taxa(taxa = rowSums(count_table == 0) > 0, x = ps)

ps2
# "only" the 836 taxa with at least one zero count

```

- Now use ps2 to go through the DESeq2 library size adjustment options

```{r}
DES = phyloseq_to_deseq2(ps2, formula(paste("~", group_var)))

# UNCOMMENT THIS AND YOU WILL GET THE ERROR:
# estimateSizeFactors(DES, type = "ratio")
```

- **NB: when you had used the original ps, you would not get the error, but only 26 out of your 862 taxa would have been considered for sizeFactor estimation!**

## Therefore you should always use the geoMeans option and give your own geometric mean as reference sample when using type = "ratio" OR use the new option type == "poscounts" when you would like to include zeros for your GM_reference sample, which I don't)

```{r}
# I use this gm function found
gm_own = function(x, na.rm=FALSE, zeros.count = TRUE){
        if(any(x < 0, na.rm = TRUE)){
                return(NaN)
        }
        if(zeros.count){
                exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x))
        } else {
                exp(sum(log(x[x > 0]), na.rm=na.rm) / length(x[x > 0]))
        }
}

GM_referenceSample <- apply(otu_table(ps2), 2, gm_own, zeros.count = FALSE)

GM_referenceSample_zerosCount <- apply(otu_table(ps2), 2, gm_own, zeros.count = TRUE)

SFs <- sizeFactors(estimateSizeFactors(DES, type = "ratio", geoMeans = GM_referenceSample))

SFs_zerosCount <- sizeFactors(estimateSizeFactors(DES, type = "ratio", geoMeans = GM_referenceSample_zerosCount))

# NB: THE zeros Count version is equal to type = "poscounts"

SFs2 <- sizeFactors(estimateSizeFactors(DES, type = "poscounts"))

identical(SFs_zerosCount, SFs2) # TRUE
```


- in conclusion: the "poscounts" option is identical to giving your own geometric mean and counting zeros in for the GM calculation
- **I would vote for NOT counting zeros hin, so I do not like the "poscounts" option as it is implemented** because for a taxon with many zeros the GM get's too small imo.


## The iterate option is annoyingly slow and results in SizeFactors that correlate well to using type = "ratio" with a GM given that ignores zero counts

- to be honest, I do not really get the iterate option
- but it is slow


```{r}
# takes about a minute or two on my MAC:
SF_iterate <- sizeFactors(estimateSizeFactors(DES, type = "iterate"))

cor(SF_iterate, SFs)

```

# Summary

- do not use the default type = "ratio" without giving geoMeans, you will usually use very few taxa for calculating your size factors
- I recommend using type = "ratio", geoMeans = GM calculated with ignoring zeros
- when you prefer to not ignore the zeros, use "poscounts"
- iterate is a slow option that I do not understand, but the size factors correlate well with the method I prefer. So I use the fast option that I do understand.
- OF note: in case of "ratio" and "poscounts": for calculating the actual size factors, i.e. the median of SampleCounts/Ref_Sample, all zeros are actually ignored by DESeq2.



